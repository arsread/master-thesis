%%==================================================
%% chapter02.tex for SJTU Master Thesis
%% based on CASthesis
%% modified by wei.jianwen@gmail.com
%% Encoding: UTF-8
%%==================================================

\chapter{相关工作}

本章主要分为两个部分。第一部分着重介绍了一些流行的代码注入的框架，第二部分介绍了通过并行化来进行程序分析的一些现有的工具。

这两个技术是本文所采用的解决方案的核心，相关工作也提供了很充分的支持。

\section{代码注入框架}
\subsection{动态二进制代码注入}
\subsubsection{Valgrind}

Valgrind\cite{valgrind}是一个用于建立动态代码分析工具的框架。它是由一系列的工具所组成，这些工具涵盖了调试，信息收集等功能。它默认的部分功能如下:

\begin{itemize}
	\item Memcheck.它能有效地检测出程序中的内存分配错误、栈溢出等故障，尤其对C和C++代码尤其有效。
	\item Cachegrind.它能收集和处理缓存和分支预测等信息，使程序的运行效率更高。
	\item Callgrind.它能收集调用图的信息和一些缓存的信息。
	\item Helgrind.它是一个线程错误侦测器，能侦测出多线程程序的错误，提高并行程序的正确性。
	\item DRD.它也是一个线程错误侦测器，但与Helgrind不同的是采用了其他的侦测技术，所以能侦测出不同的多线程错误。
	\item Massif.它是一个堆检测和优化器，能堆程序的堆使用进行检测，使程序使用更少的内存。
	\item DHAT.它是另一个堆检测和优化器，能提供程序块的生命周期，块使用情况和布局信息等。
\end{itemize}

Valgrind的工具是以插件的形式完成。工具的主要作用是以一定的规则处理Valgrind核型交付给它的代码。Valgrind使用了动态二进制重编译的方法来完成插桩。在执行过程中，首先编写好的工具被启动，然后将客户端程序即被分析程序加载进来，然后重编译客户端程序的二进制机器码。重编译后的代码被存储在一个代码缓存中，以便需要时能重新调出使用。

\subsubsection{DynamoRIO}

DynamoRIO是一个建立在IA32架构上，并适用于Windows、Linux等操作系统的框架。与其他类似得到框架相比，它能够分析比较大的程序，例如一些大型的桌面程序。

目前动态二进制动态代码注入工具普遍采用虚拟机及二进制代码解释的方法。但这个方法存在一定的不足，如在解释的时候需要通过模拟器来执行，影响了运行的效率。DynamoRIO采用了一个方法来解决这个问题，即把注入后的代码进行缓存，以便下次使用的时候就能直接引用这些注入后的代码。

DynamoRIO拷贝基本块里的代码到代码缓存中，然后在本地进行执行。在每个基本块的最后程序的执行状态会被记录并返回给DynamoRIO，以便DynamoRIO进行上下文切换。

DynamoRIO维持了一些线程私有的代码缓存，每个缓存都指向了一个基本块缓存和一个轨迹缓存。研究表明在大多数多线程程序中，只有很少的一部分代码是被多个线程共同使用的，故而事实上为每个共享代码块在每个线程中维持缓存并保持同步更新是会增加其开销的。

\subsubsection{Pin}

Pin\cite{pin}是Intel开发的一个动态二进制代码的注入和修改系统。它基于一个注入引擎，并为用户提供了一整套完善丰富的接口。通过使用这套接口，用户能自定义一些注入方式和代码，这些以插件形式自定义的设置称为Pintools.Pintools支持多种指令集如IA-32,IA-65,ARM等，以及诸如Windows、Linux等操作系统。Pin能允许用户在程序的任何代码点中插入函数调用。它能够自动地识别寄存器，故而被插入的代码段的寄存器使用不会覆盖原程序的寄存器。

Pin，Pintools和原程序是在同一个地址空间上执行的。Pin使用了ptrace来控制原程序的运行，并相应地获得处理器的信息。然后Pin开始读取用户自定义的Pintools，分析并加载其中的相关信息，进行初始化。最后Pin开始解释/编译原程序的代码，编译出来的二进制代码就是加入了用户自定义的代码段的二进制代码。

Pin的组成包括了一个虚拟机系统和一个代码缓存系统。虚拟机系统里包括了一个即时编译器，一个模拟器和一个调度器.模拟器负责执行一些无法被直接执行的代码，例如需要被虚拟机特别处理的一些系统调用等。调度器负责决定下一段需要被即时编译器编译的代码段。

Pin采用了一些技术来提高效率，例如代码内嵌，寄存器重分配，存活变量分析，指令调度等，因而它的效率相对于其他的类似工具普遍能提高。如相对于Valgrind和DynamoRIO，在基本块计数这一任务中，Pin能够比Valgrind快3.3倍，比DynamoRIO快2倍。

\subsubsection{其他工具}
